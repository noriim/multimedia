<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8"> <!-- Magyar karakterek támogatása -->
    <title>Sobics Játék</title>
    <style>
        #gameCanvas {
            border: 1px solid black; /* Keret hozzáadása a játékhoz */
        }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<audio id="backgroundMusic" src="backgroundMusic.mp3" loop></audio>
<audio id="removeSound" src="removeSound.mp3"></audio>

<script>
    window.onload = function() {
        // HTML5 Canvas beállítása
        var canvas = document.getElementById('gameCanvas');
        var ctx = canvas.getContext('2d');
        var backgroundMusic = document.getElementById('backgroundMusic');
        backgroundMusic.volume = 0.25;
        var removeSound = document.getElementById('removeSound');
        removeSound.volume = 0.25;
        function playRemoveSound() {
            removeSound.play();
        }
        var gameStarted = false;
        var firstClickAfterStart = false;
        var clickCount = 0;
        var newRowNeeded = false;

        function startGame() {
            firstClickAfterStart = true;
            setInterval(updateGame, 1000);
        }

        // Játékállapot
        var game = {
            score: 0,
            time: 0, // Új változó az eltelt idő nyomon követésére
            powerups: [],
            grid: [], // A rács, amely a blokkokat tárolja
            // ...
        };

        // Rajzoljuk meg a "Play" gombot
        function drawPlayButton() {
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, canvas.height / 3);
            ctx.lineTo(canvas.width / 2 + 50, canvas.height / 2);
            ctx.lineTo(canvas.width / 2, canvas.height / 3 * 2);
            ctx.closePath();
            ctx.stroke();
        }

        drawPlayButton();

        // Karakter képének betöltése
        var characterImage = new Image();
        characterImage.onload = function() {
            // A kép betöltődött, most már használhatod a drawImage függvényben
        };
        characterImage.src = 'character.png'; // Adja meg a karakter képének URL-jét

        // Karakter állapota
        var character = {
            position: { x: 0, y: canvas.height - 60 }, // Frissítve az alacsonyabb vászonhoz
            heldBlocks: [] // A karakter által tartott blokkok
        };

        // Egérpozíció nyomon követése
        canvas.addEventListener('mousemove', function(event) {
            var rect = canvas.getBoundingClientRect();
            var mouseX = event.clientX - rect.left;
            if (gameStarted) {
                character.position.x = Math.floor(mouseX / 80) * 80 + 40 - characterImage.width * (60 / characterImage.height) / 2;
                drawGame(); // Rajzolja újra a játékot az egér mozgásával
            }
        }, false);

        // Egérkattintás-eseménykezelő
        canvas.addEventListener('click', function(event) {
            var rect = canvas.getBoundingClientRect();
            var mouseX = event.clientX - rect.left;
            var column = Math.floor(mouseX / 80); // Az oszlop, amelyben az egér van
            if (!gameStarted) {
                // Háttérzene lejátszása
                backgroundMusic.play();
                gameStarted = true;
                startGame(); // Indítsd el a játékot
            } else if (gameStarted && firstClickAfterStart) {
                clickCount++;
                if (clickCount === 10) {
                    newRowNeeded = true;
                    clickCount = 0;
                }
                if (character.heldBlocks.length > 0) {
                    // Ha a karakter tart blokkokat, akkor rakja le őket
                    for (var i = 0; i < 17; i++) { // Kezdjük a felső sorral
                        if (!game.grid[i][column]) {
                            // Ha a cella üres, akkor ide rakjuk le a blokkot
                            var block = character.heldBlocks.pop();
                            block.y = i;
                            game.grid[i][column] = block;
                            if (character.heldBlocks.length === 0) {
                                break;
                            }
                        }
                    }
                } else {
                    // Ha a karakter nem tart blokkokat, akkor vegyen fel néhányat
                    var colorToPickUp = null;
                    for (var i = 16; i >= 0; i--) { // Kezdjük az alsó sorral
                        var block = game.grid[i][column];
                        if (block && (!colorToPickUp || block.color === colorToPickUp)) {
                            // Ha a cella nem üres, és ugyanolyan színű, mint a felveendő blokkok, akkor vegyük fel a blokkot
                            character.heldBlocks.push(block);
                            game.grid[i][column] = null;
                            colorToPickUp = block.color;
                        } else if (colorToPickUp) {
                            // Ha már felvettünk egy blokkot, és a következő blokk más színű, akkor álljunk le
                            break;
                        }
                    }
                }
                while (removeBlocks()) {
                    updateGrid();
                }

                drawGame(); // Rajzolja újra a játékot a kattintás után
            }
        }, false);

        // Rács inicializálása
        for (var i = 0; i < 17; i++) { // 17 sor
            game.grid[i] = [];
            for (var j = 0; j < 10; j++) { // 10 oszlop
                game.grid[i][j] = null;
            }
        }

        // Alap blokkok hozzáadása
        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 10; j++) {
                var block = {
                    x: j, // Oszlop
                    y: i, // Sor
                    color: getRandomColor(), // Véletlenszerű szín kiválasztása
                };
                game.grid[block.y][block.x] = block;
            }
        }

        // Véletlenszerű szín generálása
        function getRandomColor() {
            var colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF', '#FFA500'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Játék rajzolása
        function drawGame() {
            // Törölje a vásznat
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Rajzolja ki a pontszámot
            ctx.fillStyle = 'black';
            ctx.font = '40px Arial'; // Nagyobb betűméret
            ctx.fillText('Pontszám: ' + game.score, 10, 40);

            // Rajzolja ki az eltelt időt
            var minutes = Math.floor(game.time / 60);
            var seconds = game.time % 60;
            ctx.fillText('Eltelt idő: ' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0'), canvas.width - 290, 40);

        // Rajzolja ki a blokkokat
            for (var i = 0; i < 17; i++) {
                for (var j = 0; j < 10; j++) {
                    var block = game.grid[i][j];
                    if (block) {
                        ctx.fillStyle = block.color;
                        ctx.fillRect(j * 80, (i * 30) + 50, 80, 30); // Frissítve az alacsonyabb vászonhoz
                    } else if (j === Math.floor(character.position.x / 80)) {
                        ctx.fillStyle = '#CCCCCC'; // Szürkés árnyalat
                        ctx.fillRect(j * 80, (i * 30) + 50, 80, canvas.height); // Frissítve az alacsonyabb vászonhoz
                    }
                }
            }

            // Rajzolja ki a karaktert és a tartott blokkokat
            var y = character.position.y;
            for (var i = character.heldBlocks.length - 1; i >= 0; i--) {
                var block = character.heldBlocks[i];
                ctx.fillStyle = block.color;
                ctx.fillRect(character.position.x, y, characterImage.width * (60 / characterImage.height), 30);
                y -= 30;
            }
            ctx.drawImage(characterImage, character.position.x, character.position.y, characterImage.width * (60 / characterImage.height), 60);
        }
// Szomszédos blokkok ellenőrzése
        function checkNeighbors(x, y, color, visited) {
            if (x < 0 || x > 9 || y < 0 || y > 16 || game.grid[y][x] === null || game.grid[y][x].color !== color || visited[y][x]) {
                return [];
            }
            visited[y][x] = true;
            var blocks = [{x: x, y: y}];
            blocks = blocks.concat(checkNeighbors(x-1, y, color, visited));
            blocks = blocks.concat(checkNeighbors(x+1, y, color, visited));
            blocks = blocks.concat(checkNeighbors(x, y-1, color, visited));
            blocks = blocks.concat(checkNeighbors(x, y+1, color, visited));
            return blocks;
        }

// Blokkok eltávolítása
        function removeBlocks() {
            var removed = false;
            for (var i = 0; i < 17; i++) {
                for (var j = 0; j < 10; j++) {
                    var block = game.grid[i][j];
                    if (block) {
                        var visited = new Array(17).fill(false).map(() => new Array(10).fill(false));
                        var blocks = checkNeighbors(j, i, block.color, visited);
                        if (blocks.length >= 4) {
                            for (var k = 0; k < blocks.length; k++) {
                                game.grid[blocks[k].y][blocks[k].x] = null;
                            }
                            game.score += blocks.length; // Növeljük a pontszámot
                            removed = true;
                            playRemoveSound();
                        }
                    }
                }
            }
            return removed;
        }

// Rács frissítése
        function updateGrid() {
            for (var j = 0; j < 10; j++) {
                var column = [];
                for (var i = 16; i >= 0; i--) {
                    if (game.grid[i][j] !== null) {
                        column.unshift(game.grid[i][j]);
                    }
                }
                while (column.length < 17) {
                    column.push(null);
                }
                for (var i = 0; i < 17; i++) {
                    game.grid[i][j] = column[i];
                }
            }
        }


// Játék frissítése
        function updateGame() {
            game.time++;
            // Csak akkor adjunk hozzá új sort, ha a clickek száma kigyűlt
            if (newRowNeeded) {
                // Új sor hozzáadása a rács tetejére
                var newRow = [];
                for (var j = 0; j < 10; j++) {
                    var block = {
                        x: j, // Oszlop
                        y: 0, // Első sor
                        color: getRandomColor(), // Véletlenszerű szín kiválasztása
                    };
                    newRow[j] = block;
                }
                game.grid.unshift(newRow);

                // A rács alján lévő sor eltávolítása, ha a rács túl nagy
                if (game.grid.length > 17) {
                    game.grid.pop();
                }
                newRowNeeded = false;
            }

            // Blokkok pozíciójának frissítése
            for (var i = 0; i < 17; i++) {
                for (var j = 0; j < 10; j++) {
                    var block = game.grid[i][j];
                    if (block) {
                        block.y = i; // A blokkok pozíciójának frissítése a rácsban
                    }
                }
            }
            while (removeBlocks()) {
                updateGrid();
            }

            drawGame();
        }

    };
</script>
</body>
</html>